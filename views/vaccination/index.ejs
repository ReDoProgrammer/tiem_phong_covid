<div class="row">
  <div class="col-sm-2">
    <button class="btn btn-success" id="btnAddNew">
      <i class="fa fa-plus" aria-hidden="true"></i>
      Thêm mới
    </button>
  </div>
  <!-- phần tìm kiếm -->
  <div class="offset-sm-6 col-sm-4">
    <div class="input-group">
      <input type="text" class="form-control" placeholder="Keyword ..." id="txtSearch" />
      <div class="input-group-btn">
        <button class="btn btn-dark" id="btnSearch">
          <i class="fa fa-search" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </div>
  <!-- kết thúc phần tìm kiếm -->
</div>
<div class="table-responsive" id="data_center">

  <table class="table table-bordered mt-20">
    <thead class="bg-info text-white text-white ">
      <tr>
        <th rowspan="2" class="align-middle font-weight-bold text-center">STT</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Họ và tên</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Giới tính</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Ngày sinh</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Email</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Đối tượng ưu tiên</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Nghề nghiệp</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Số điện thoại</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">CMND/CCCD</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Số thẻ BHYT</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Dân tộc</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Quốc tịch</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Địa chỉ</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">CSYT tiêm</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Ghi chú</th>
        <th colspan="3" class="text-center font-weight-bold text-center">Mũi 1</th>
        <th colspan="3" class="text-center font-weight-bold text-center">Mũi 2</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center">Người nhập</th>
        <th rowspan="2" class="align-middle font-weight-bold text-center"></th>
      </tr>
      <tr>
        <th class="text-center">Loại vaccin</th>
        <th class="text-center">Ngày tiêm</th>
        <th class="text-center">Lô vaccin</th>
        <th class="text-center">Loại vaccin</th>
        <th class="text-center">Ngày tiêm</th>
        <th class="text-center">Lô vaccin</th>

      </tr>

    </thead>
    <tbody id="tblData">

    </tbody>
  </table>
</div>


<script src="../../dist/date-picker/js/bootstrap-datepicker.min.js"></script>
<link rel="stylesheet" href="../../dist/date-picker/css/bootstrap-datepicker.css">
<!-- <link rel="stylesheet" href="../../css/bootstrap-glyphicons.css"> -->
<%-include('modal_vaccination')%>

  <script>
    var search = "";
    $(document).ready(function () {
      LoadCV();
    })

    $(document).on("click", "button[name='delete']", function () {
      let cvId = $(this).closest("tr").attr("id");
      let cvName = $(this).closest("tr").data("name");
      var r = confirm(
        "Bạn thực sự muốn xóa hồ sơ của " + cvName + "?"
      );
      if (r) {
        $.ajax({
          url: '/danh-sach-tiem-phong-covid-19',
          type: 'delete',
          headers: {
            Authorization: "Covid-19 " + getACCESS_TOKEN()
          },
          data: {
            cvId
          },
          success: function (data) {
            alert(data.msg);
            LoadCV();
          },
          error: function (jqXHR, textStatus, errorThrown) {
            alert(jqXHR.responseJSON.msg);
          },

        })
      }
    })

    $('#btnAddNew').click(function () {
      $('#modalVaccination').modal();
    })

    $("#modalVaccination").on("hidden.bs.modal", function () {
      LoadCV();
    });

    $('#btnSearch').click(function () {
      search = $('#txtSearch').val();
      LoadCV();
    })

    function LoadCV() {
      $.ajax({
        url: '/danh-sach-tiem-phong-covid-19/list',
        type: 'get',
        headers: {
          Authorization: "Covid-19 " + getACCESS_TOKEN()
        },
        data: {
          search
        },
        success: function (data) {
          let idx = 1;
          $('#tblData').empty();
          data.cv.forEach(c => {
            let tr = '<tr id="' + c._id + '" data-name="' + UppercaseEachFirstLetter(c.fullname) + '">';
            tr += '<td class="text-nowrap text-right">' + (idx < 10 ? '0' + (idx++) : (idx++)) + '</td>';
            tr += '<td class="text-nowrap">' + UppercaseEachFirstLetter(c.fullname) + '</td>';
            tr += '<td class="text-nowrap">';
            tr += c.gender == 1 ? 'Nam' : (c.gender == 2 ? 'Nữ' : 'Không rõ');
            tr += '</td>';
            tr += '<td class="text-nowrap">' + c.dob + '</td>';
            tr += '<td class="text-nowrap">' + c.email + '</td>';
            tr += '<td class="text-nowrap">' + c.po_id.name + '</td>';
            tr += '<td class="text-nowrap">' + c.job_id.name + '</td>';
            tr += '<td class="text-nowrap">' + c.phone + '</td>';
            tr += '<td class="text-nowrap">' + c.id_number + '</td>';
            tr += '<td class="text-nowrap">' + c.hi_no + '</td>';
            tr += '<td class="text-nowrap">' + c.nation_id.name + '</td>';
            tr += '<td class="text-nowrap">' + c.nationality_id.name + '</td>';
            tr += '<td class="text-nowrap">';
            if (c.detail_address.trim().length > 0) {
              tr += c.detail_address + ' - ';
            }
            tr += c.ward_id.name + ' - ' + c.dist_id.name + ' - ' + c.prov_id.name + ' - ' + c.nationality_id.name
            tr += '</td>';
            tr += '<td class="text-nowrap">' + c.hf_id.name + '</td>';
            tr += '<td class="text-nowrap">' + c.remark + '</td>';

            if (c.date1.length > 0) {
              tr += '<td class="text-nowrap">' + c.vaccin1.name + '</td>';
              tr += '<td class="text-nowrap">' + c.date1 + '</td>';
              tr += '<td class="text-nowrap">' + c.no1 + '</td>';
            } else {
              tr += '<td></td>';
              tr += '<td></td>';
              tr += '<td></td>';
            }

            if (c.date2.length > 0) {
              tr += '<td class="text-nowrap">' + c.vaccin2.name + '</td>';
              tr += '<td class="text-nowrap">' + c.date2 + '</td>';
              tr += '<td class="text-nowrap">' + c.no2 + '</td>';
            } else {
              tr += '<td></td>';
              tr += '<td></td>';
              tr += '<td></td>';
            }


            tr += '<td class="text-nowrap">' + c.created_by.fullname + '</td>';
            tr += '<td class="text-right">';
            if (c.created_by._id == data.user_id) {
              tr += '<button  name = "delete" class = "btn btn-sm btn-danger ml-2"><i class="fa fa-trash" aria-hidden="true"></i></button>';
            }
            tr += '</td>';
            tr += '</tr>';
            $('#tblData').append(tr);
          })

        }, error: function (jqXHR, textStatus, errorThrown) {
          alert(jqXHR.responseJSON.msg);
        },
      })
    }
  </script>

  <style>
    #data_center {
      display: inline-block;
      overflow-y: scroll;
      max-height: 550px;
    }

    table {
      text-align: left;
      position: relative;
    }

    thead {
      position: sticky;
      top: 0;
    }
  </style>